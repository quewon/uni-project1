<!DOCTYPE html>
<html lang="ko" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>로봇 방물관</title>
    <style>
      html {
        font-family: 'Nanum Gothic Coding', monospace;
        --star: #faecd4;
        --ui: #6c9bb8;
        --bg: #172445;
      }

      body {
        background-color: var(--star);
      }

      canvas {
        position: absolute;
        transform: translate(-50%, -50%);
        left: 50%;
        top: 50%;
        width: 400px;
        height: 400px;
        image-rendering: optimizeSpeed;
        image-rendering: -moz-crisp-edges;
        image-rendering: -webkit-optimize-contrast;
        image-rendering: -o-crisp-edges;
        image-rendering: crisp-edges;
        -ms-interpolation-mode: nearest-neighbor;
      }

      .hidden {
        opacity: 0 !important;
        transition: 0.5s;
      }
    </style>
  </head>
  <body>
    <div id="loading">
      *
    </div>
    <canvas class="hidden" id="bg"></canvas>
    <canvas class="hidden" id="main"></canvas>
    <canvas id="ui"></canvas>
  </body>
  <script src="sound/howler.core.js"></script>
  <script type="text/javascript">
    var config = {
      tilesX: 4,
      tilesY: 10,
      stars: ["*", "✦", ".", "✵", "*", "·", "✧", "·", "+", "✺"],
      updateSpeed: 150,
      gravity: 50,

      minArtSize: 5,
      maxArtSize: 15,
    };

    var tiles = {
      drops: [
        [
          [1, 1, 1, 1, 1, 1, 1],
          [0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0],
          [1, 0, 0, 0, 0, 0, 1]
        ],
        [
          [1, 1, 1, 1, 1, 1, 1],
          [0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0]
        ]
      ],
      landings: [
        [
          [1, 0, 0, 0, 0, 0, 1],
          [0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0],
          [1, 1, 1, 1, 1, 1, 1]
        ],
        [
          [0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0],
          [1, 1, 1, 1, 1, 1, 1]
        ]
      ],
      rooms: [
        [
          [1, 1, 1, 1, 1, 1, 1],
          [0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0],
          [1, 1, 1, 1, 1, 1, 1]
        ],
        [
          [1, 1, 1, 1, 1, 1, 1],
          [1, 0, 0, 0, 0, 0, 1],
          [0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0],
          [1, 1, 1, 1, 1, 1, 1]
        ],
        [
          [1, 1, 1, 1, 1, 1, 1],
          [0, 0, 0, 0, 0, 0, 1],
          [0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0],
          [1, 1, 1, 1, 1, 1, 1]
        ],
        [
          [1, 1, 1, 1, 1, 1, 1],
          [1, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0],
          [1, 1, 1, 1, 1, 1, 1]
        ],
        [
          [1, 1, 1, 1, 1, 1, 1],
          [1, 1, 1, 1, 1, 1, 1],
          [0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0],
          [1, 1, 1, 1, 1, 1, 1]
        ],
        [
          [1, 0, 0, 0, 0, 0, 1],
          [0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0],
          [1, 1, 1, 1, 1, 1, 1]
        ],
        [
          [0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0],
          [1, 1, 1, 1, 1, 1, 1]
        ],
      ]
    };

    var sound = [
      [
        new Howl({src: "sound/0_0.wav"}),
        new Howl({src: "sound/0_1.wav"}),
        new Howl({src: "sound/0_2.wav"}),
        new Howl({src: "sound/0_3.wav"}),
        new Howl({src: "sound/0_4.wav"}),
        new Howl({src: "sound/0_5.wav"}),
        new Howl({src: "sound/0_6.wav"}),
        new Howl({src: "sound/0_7.wav"}),
        new Howl({src: "sound/0_8.wav"}),
        new Howl({src: "sound/0_9.wav"}),
      ],
      [
        new Howl({src: "sound/1_0.wav"}),
        new Howl({src: "sound/1_1.wav"}),
        new Howl({src: "sound/1_2.wav"}),
        new Howl({src: "sound/1_3.wav"}),
        new Howl({src: "sound/1_4.wav"}),
        new Howl({src: "sound/1_5.wav"}),
        new Howl({src: "sound/1_6.wav"}),
        new Howl({src: "sound/1_7.wav"}),
        new Howl({src: "sound/1_8.wav"}),
        new Howl({src: "sound/1_9.wav"}),
      ],
      [
        new Howl({src: "sound/2_0.wav"}),
        new Howl({src: "sound/2_1.wav"}),
        new Howl({src: "sound/2_2.wav"}),
        new Howl({src: "sound/2_3.wav"}),
        new Howl({src: "sound/2_4.wav"}),
        new Howl({src: "sound/2_5.wav"}),
        new Howl({src: "sound/2_6.wav"}),
        new Howl({src: "sound/2_7.wav"}),
        new Howl({src: "sound/2_8.wav"}),
        new Howl({src: "sound/2_9.wav"}),
      ]
    ];

    var _loading = document.getElementById("loading");
    window.onload = function() {
      let loading = setInterval(function() {
        _loading.textContent = config.stars[Math.random() * config.stars.length | 0];

        loaded = true;

        check: for (lib in sound) {
          for (sfx in sound[lib]) {
            if (sound[lib][sfx].state() != "loaded") loaded = false;
            break check;
          }
        }

        if (loaded) {
          _loading.classList.add("hidden");
          clearInterval(loading);
          init();
        }
      }, 100);
    }

    var _canvas = document.getElementById("main");
    var _main = _canvas.getContext("2d");
    var _bg = document.getElementById("bg").getContext("2d");
    var _ui = document.getElementById("ui").getContext("2d");
    var _loop;
    function init() {
      cX = tiles.drops[0][0].length * config.tilesX;
      cY = tiles.drops[0].length * config.tilesY;

      let canvases = document.querySelectorAll("canvas");
      for (canvas in canvases) {
        canvases[canvas].width = cX;
        canvases[canvas].height = cX;
      }

      Array.from(document.querySelectorAll("canvas")).forEach((el) => el.classList.remove("hidden"));

      document.addEventListener("keydown", function(e) {
        if (e.repeat) return

        let k = e.keyCode;

        chars.player.keyHandler[k] = e.type == 'keydown';
        chars.player.history.unshift(k);
        clearInterval(_loop);
        playerUpdate();
        _loop = setInterval(playerUpdate, config.updateSpeed);
      });
      document.addEventListener("keyup", function(e) {
        let k = e.keyCode;

        chars.player.keyHandler[k] = e.type == 'keydown';

        if (k == chars.player.history[0]) {
          chars.player.history.shift();
        }
      })

      generateMap();
      draw();
      setInterval(update, config.gravity);
    }

    function draw() {
      let vmax = config.viewport;
      _main.clearRect(0, 0, cX, vmax);
      _bg.clearRect(0, 0, cX, vmax);
      _ui.clearRect(0, 0, cX, vmax);

      let vy = 0;
      let vx = chars.player.pos.x - Math.floor(cX/2);

      // camera

      let halfvmax = Math.floor(vmax / 2);
      if (chars.player.pos.y >= halfvmax) {
        if (chars.player.pos.y >= cY - halfvmax) {
          vy = cY - config.viewport;
        } else {
          vy = chars.player.pos.y - halfvmax;
        }
      }

      //vx: coords of player relative to center

      if (vx >= 0) {
        let i=0;
        for (let y=vy; y<vy+config.viewport; y++) {
          for (let x=vx; x<cX; x++) {
            _bg.globalCompositeOperation = "source-over";
            // console.log(cmap[y][x])
            if (cmap[y][x] != 0) {
              _bg.fillStyle = cmap[y][x];
              _bg.fillRect(x-vx, i, 1, 1);

              // 블렌딩모드
              _bg.globalCompositeOperation = "exclusion";
              _bg.fillStyle = "#172445";
              _bg.fillRect(x-vx, i, 1, 1);

              // 블렌딩모드
              _bg.globalCompositeOperation = "hard-light";
              _bg.fillStyle = "#faecd4";
              _bg.fillRect(x-vx, i, 1, 1);

              // 블렌딩모드
              _bg.globalCompositeOperation = "multiply";
              _bg.fillStyle = "#faecd4";
              _bg.fillRect(x-vx, i, 1, 1);
            }

            // ch

            if (smap[y][x].includes("B")) {
              _main.fillStyle = Math.floor(Math.random()*16777215).toString(16);
              _main.fillRect(x-vx, i, 1, 1);

              // _main.globalCompositeOperation = "exclusion";
              // _main.fillStyle = "#172445";
              // _main.fillRect(x, i, 1, 1);
            }
          }
          i++;
        }
        i=0;
        for (let y=vy; y<vy+config.viewport; y++) {
          for (let x=0; x<=vx; x++) {
            let nx = cX-vx+x;
            _bg.globalCompositeOperation = "source-over";
            if (cmap[y][x] != 0) {
              _bg.fillStyle = cmap[y][x];
              _bg.fillRect(nx, i, 1, 1);

              // 블렌딩모드
              _bg.globalCompositeOperation = "exclusion";
              _bg.fillStyle = "#172445";
              _bg.fillRect(nx, i, 1, 1);

              // 블렌딩모드
              _bg.globalCompositeOperation = "hard-light";
              _bg.fillStyle = "#faecd4";
              _bg.fillRect(nx, i, 1, 1);

              // 블렌딩모드
              _bg.globalCompositeOperation = "multiply";
              _bg.fillStyle = "#faecd4";
              _bg.fillRect(nx, i, 1, 1);
            }

            // ch

            if (smap[y][x].includes("B")) {
              _main.fillStyle = Math.floor(Math.random()*16777215).toString(16);
              _main.fillRect(nx, i, 1, 1);

              // _main.globalCompositeOperation = "exclusion";
              // _main.fillStyle = "#172445";
              // _main.fillRect(x, i, 1, 1);
            }
          }
          i++;
        }
      } else {
        let i=0;
        for (let y=vy; y<vy+config.viewport; y++) {
          for (let x=0; x<cX+vx; x++) {
            _bg.globalCompositeOperation = "source-over";
            if (cmap[y][x] != 0) {
              _bg.fillStyle = cmap[y][x];
              _bg.fillRect(x-vx, i, 1, 1);

              // 블렌딩모드
              _bg.globalCompositeOperation = "exclusion";
              _bg.fillStyle = "#172445";
              _bg.fillRect(x-vx, i, 1, 1);

              // 블렌딩모드
              _bg.globalCompositeOperation = "hard-light";
              _bg.fillStyle = "#faecd4";
              _bg.fillRect(x-vx, i, 1, 1);

              // 블렌딩모드
              _bg.globalCompositeOperation = "multiply";
              _bg.fillStyle = "#faecd4";
              _bg.fillRect(x-vx, i, 1, 1);
            }

            // ch

            if (smap[y][x].includes("B")) {
              _main.fillStyle = Math.floor(Math.random()*16777215).toString(16);
              _main.fillRect(x-vx, i, 1, 1);

              // _main.globalCompositeOperation = "exclusion";
              // _main.fillStyle = "#172445";
              // _main.fillRect(x, i, 1, 1);
            }
          }
          i++;
        }
        i=0;
        for (let y=vy; y<vy+config.viewport; y++) {
          let ii=0;
          for (let x=cX-Math.abs(vx); x<cX; x++) {
            let nx = ii;
            _bg.globalCompositeOperation = "source-over";
            if (cmap[y][x] != 0) {
              _bg.fillStyle = cmap[y][x];
              _bg.fillRect(nx, i, 1, 1);

              // 블렌딩모드
              _bg.globalCompositeOperation = "exclusion";
              _bg.fillStyle = "#172445";
              _bg.fillRect(nx, i, 1, 1);

              // 블렌딩모드
              _bg.globalCompositeOperation = "hard-light";
              _bg.fillStyle = "#faecd4";
              _bg.fillRect(nx, i, 1, 1);

              // 블렌딩모드
              _bg.globalCompositeOperation = "multiply";
              _bg.fillStyle = "#faecd4";
              _bg.fillRect(nx, i, 1, 1);
            }

            // ch

            if (smap[y][x].includes("B")) {
              _main.fillStyle = Math.floor(Math.random()*16777215).toString(16);
              _main.fillRect(nx, i, 1, 1);

              // _main.globalCompositeOperation = "exclusion";
              // _main.fillStyle = "#172445";
              // _main.fillRect(x, i, 1, 1);
            }
            ii++;
          }
          i++;
        }
      }

      _main.globalCompositeOperation = "source-over";
      _main.fillStyle = "#172445";
      _main.fillRect(chars.player.pos.x - vx, chars.player.pos.y - vy, 1, 1);

      if (smap[chars.player.pos.y - 1][chars.player.pos.x].includes("B")) {
        _ui.globalCompositeOperation = "source-over";
        let i = chars.player.pos.y-2;
        let b = chars[smap[chars.player.pos.y-1][chars.player.pos.x]];

        var dx = Math.round((cX - b.artwork[0].length) / 2);
        var dy = Math.round((config.viewport - b.artwork.length) / 2);

        // 프레임
        _ui.fillStyle = "#172445";
        _ui.fillRect(dx - 1, dy - 1, b.artwork[0].length + 2, b.artwork.length + 2);

        for (y in b.artwork) {
          for (x in b.artwork[y]) {
            _ui.globalCompositeOperation = "source-over";
            _ui.fillStyle = b.artwork[y][x];
            let nx = parseInt(x)+dx;
            let ny = parseInt(y)+dy;
            _ui.fillRect(nx, ny, 1, 1);

            _ui.globalCompositeOperation = "exclusion";
            _ui.fillStyle = b.filter;
            _ui.fillRect(nx, ny, 1, 1);
          }
        }
      }

      window.requestAnimationFrame(draw);
    }

    var timer = 0;
    function update() {
      timer++;

      //physics

      let p = chars.player;
      if (cmap[p.pos.y+1][p.pos.x] == 0) {
        for (let i=0; i<=p.velocity; i++) {
          if (cmap[p.pos.y+1][p.pos.x] == 0) {
            p.pos.y++;
          }
        }
        p.velocity++;
      } else {
        p.velocity = 1;
      }
    }

    function playerUpdate() {
      let p = chars.player;
      for (let i in p.keyHandler) {
        if (p.keyHandler[i]) {
          let map = p.keyMap;
          var sfx = sound[0][Math.random() * sound[0].length | 0];
          let volume = Math.floor(Math.random() * 3);
          switch (volume) {
            case 0:
              sfx.volume(0.6);
              break;
            case 1:
              sfx.volume(0.8);
              break;
            case 2:
              sfx.volume(1);
              break;
          }

          switch (""+i) {
            case map.left:
              if (p.history[0] != map.right) {
                if (!cmap[p.pos.y][p.pos.x - 1] || !cmap[p.pos.y - 1][p.pos.x - 1]) {
                  p.pos.x -= 1;
                  sfx.play();

                  if (cmap[p.pos.y][p.pos.x - 1] && !cmap[p.pos.y - 1][p.pos.x - 1]) {
                    p.pos.y -= 1;
                  }
                }
              }
              break;
            case map.right:
              if (p.history[0] != map.left) {
                if (!cmap[p.pos.y][p.pos.x + 1] || !cmap[p.pos.y - 1][p.pos.x + 1]) {
                  p.pos.x += 1;
                  sfx.play();

                  if (cmap[p.pos.y][p.pos.x + 1] && !cmap[p.pos.y - 1][p.pos.x + 1]) {
                    p.pos.y -= 1;
                  }
                }
              }
              break;
          }

          if (p.pos.x >= smap[p.pos.y].length) {
            p.pos.x = 0;
          } else if (p.pos.x < 0) {
            p.pos.x = smap[p.pos.y].length - 1
          }
        }
      }
    }

    // 맵 생성
    var map = [];
    var spawn;
    var cmap = [];
    var smap = [];
    var cX, cY;
    var chars = {
      player: {
        pos: { x: undefined, y: undefined },
        keyHandler: {},
        keyMap: {
          left: "37",
          right: "39"
        },
        history: [],
        velocity: 0,
      }
    };
    function generateMap() {
      let botspawns = [];

      for (let y=0; y<config.tilesY; y++) {
        map[y] = [];
      }

      for (let y=0; y<config.tilesY; y++) {
        // place drop
        if (y !== config.tilesY - 1) {
          let drop = tiles.drops[Math.random() * tiles.drops.length | 0];
          var random = (Math.random() * config.tilesX) | 0;
          while (map[y][random]) {
            random = (Math.random() * config.tilesX) | 0;
          }
          map[y][random] = [...drop];

          if (y == 0) {
            spawn = (Math.random() * config.tilesX) | 0;
            while (spawn == random) {
              spawn = (Math.random() * config.tilesX) | 0;
            }
          }
        }

        if (map[y+1]) {
          let landing = tiles.landings[Math.random() * tiles.landings.length | 0];
          map[y+1][random] = [...landing];
        }

        let potential_botspawns = [];
        for (let x=0; x<config.tilesX; x++) {
          if (!map[y][x]) {
            let room = tiles.rooms[Math.random() * tiles.rooms.length | 0];
            map[y][x] = [...room];

            potential_botspawns.push(x);
          }
        }

        if (y == 0) potential_botspawns.splice(potential_botspawns.indexOf(spawn), 1);

        let botsInFloor = Math.floor((Math.random() * potential_botspawns.length - 1) + 1);

        botspawns[y] = [];
        for (let i=0; i<=botsInFloor; i++) {
          let rand = Math.random() * potential_botspawns.length | 0;
          botspawns[y].push(potential_botspawns[rand]);
          potential_botspawns.splice(potential_botspawns.indexOf(rand), 1);
        }

        for (let i=0; i<tiles.drops[0].length; i++) {
          let rownum = (y * tiles.drops[0].length) + i;
          let array = [];

          for (let x=0; x<config.tilesX; x++) {
            array = array.concat(map[y][x][i]);
          }

          cmap[rownum] = [...array];
        }
      }

      for (let y in cmap) {
        smap[y] = [];
        for (let x in cmap[y]) {
          smap[y][x] = [];
          if (cmap[y][x] == 1) {
            cmap[y][x] = Math.floor(Math.random()*16777215).toString(16);
          }
        }
      }

      config.viewport = Math.floor(document.getElementById("main").height);
      if (config.viewport > cmap.length) config.viewport = cmap.length - 1;

      // 플레이어 생성

      chars.player.pos.y = tiles.drops[0].length - 2;
      chars.player.pos.x = (spawn*tiles.drops[0][0].length) + Math.floor(tiles.drops[0][0].length / 2);

      console.log(botspawns);

      // 로봇 생성
      for (let y in map) {
        for (let bot in botspawns[y]) {
          let x = botspawns[y][bot]*tiles.drops[0][0].length + Math.floor(tiles.drops[0][0].length / 2);
          let by = y*tiles.drops[0].length + tiles.drops[0][0].length - 3;
          smap[by][x] = "B"+by+x;

          chars["B"+by+x] = {
            artwork: generateArt(),
            comment: generateComment(),
            filter: Math.floor(Math.random()*16777215).toString(16),
          }
        }
      }
    }

    function generateArt() {
      let array = [];

      let ysize = (Math.random() * (config.maxArtSize - config.minArtSize)) + config.minArtSize;
      let xsize = (Math.random() * (config.maxArtSize - config.minArtSize)) + config.minArtSize;
      for (let y=0; y<ysize; y++) {
        array[y] = [];
        for (let x=0; x<xsize; x++) {
          array[y][x] = Math.floor(Math.random()*16777215).toString(16);
        }
      }

      return array
    }

    function generateComment() {
      return "🤖"
    }
  </script>
</html>
